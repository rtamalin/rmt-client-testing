#!/bin/bash

set -eu
if [[ -n "${TRACE:+true}" ]]; then
    set -vx
fi

cmdName=$(basename ${BASH_SOURCE[0]})
binDir=$(readlink -e $(dirname ${BASH_SOURCE[0]}))
repoDir=$(dirname ${binDir})
rmtEnv=${repoDir}/.env
rmtCntr=${RMT_CNTR:-rmt-rmt-1}

if [[ ! -r ${rmtEnv} ]]; then
    echo "Ensure env is setup"
    exit 1
fi

. ${rmtEnv}

if [[ -n "${RMT_CNTR}" ]]; then
    # Use docker if a container name is set
    runner=docker
else
    # Otherwise using SSH
    runner=ssh
fi

runnerArgs=()

case "${runner}" in
(docker)
    runnerArgs+=(
        exec
        -ti
        ${rmtCntr}
    )
    ;;
(ssh)
    runnerArgs+=(
        ${RMT_USER:+${RMT_USER}@}${RMT_HOST}
    )
    ;;
(*)
    echo "ERROR: Not a supported runner: '${runner}'"
    exit 1
    ;;
esac

exec \
    ${DEBUG:+echo} \
    ${runner} \
    "${runnerArgs[@]}" \
    rmt-cli \
    "${@}"

# vim:shiftwidth=4:tabstop=4:expandtab
