#!/bin/bash

set -eu

if [[ -n "${TRACE:+true}" ]]; then
    set -v -x
fi

cmdName=$(basename ${BASH_SOURCE[0]})
binDir=$(readlink -e $(dirname ${BASH_SOURCE[0]}))
repoDir=$(dirname ${binDir})
envFile=${repoDir}/.env
instData=instData.xml

if (( $# < 1 )); then
    echo "Usage: ${cmdName} [<user>@]<pcrmt>"
    exit 1
fi

if [[ -s "${envFile}" ]]; then
    echo "ERROR: An environment file, ${envFile}, already exists."
    exit 1
fi

pcrmtHost="${1}"
case "${pcrmtHost}" in
    (*@*)
        pcrmtUser="${pcrmtHost%@*}"
        pcrmtHost="${pcrmtHost#${pcrmtUser}@}"
        ;;
esac

pcrmtIp=$(getent hosts ${pcrmtHost} | awk '{print $1}')
if [[ -z "${pcrmtIp}" ]]; then
    echo "ERROR: unable to resolve '${pcrmtHost}' to an IP Address."
    echo "       If not managed by DNS configure a /etc/hosts override."
    exit 1
fi

pcrmtCert=rmt-ca.crt
echo "[Retrieving RMT CA Cert as ${pcrmtCert}]"
wget -qO ${repoDir}/${pcrmtCert} http://${pcrmtHost}/rmt.crt

echo "[Generating .env file]"
ssh "${1}" "python3 -c 'import yaml; \
sq = chr(0x27); \
rmt_conf = yaml.safe_load(open(\"/etc/rmt.conf\").read()); \
db_conf = rmt_conf[\"database\"]; \
rmt_db = db_conf[\"database\"]; \
rmt_host = db_conf[\"host\"]; \
rmt_passwd = db_conf[\"password\"]; \
rmt_user = db_conf[\"username\"]; \
print( \
f\"# RMT Tester Environment Settings\n\" \
\"#\n\" \
\"# NOTE: Included by both shell and Makefile, so stick to var=value assignments\n\" \
\"\n\" \
\"# RMT Environment - one of [docker, remote, pubcloud]\n\" \
\"RMT_ENV=pubcloud\n\" \
\"\n\" \
\"# RMT Connectivity Settings\n\" \
\"#RMT_CNTR=rmt-rmt-1\n\" \
\"RMT_CERT=${repoDir}/${pcrmtCert}\n\" \
\"RMT_HOST=${pcrmtHost}\n\" \
\"RMT_IP=${pcrmtIp}\n\" \
\"RMT_USER=${pcrmtUser:- #Specify if needed}\n\" \
\"EXTERNAL_PORT=${EXTERNAL_PORT:- #Configure an external port if needed}\n\" \
\"\n\" \
\"# MariaDB (mysql) Settings\n\" \
f\"MYSQL_DATABASE={sq}{rmt_db}{sq}\n\" \
f\"MYSQL_HOST={sq}{rmt_host}{sq}\n\" \
f\"MYSQL_PASSWORD={sq}{rmt_passwd}{sq}\n\" \
f\"MYSQL_USER={sq}{rmt_user}{sq}\n\" \
\"\n\" \
\"# Product Registration Settings\n\" \
\"PRODUCT=SLES\n\" \
\"VERSION=15.7\n\" \
\"ARCH=x86_64\n\" \
\"REG_CODE=${regCode:- #Not needed for PubCloud RMT}\n\" \
\"INST_DATA=${instData:- #Needed for PubCloud RMT}\n\" \
); \
'" > ${envFile}

exit 0

# vim:shiftwidth=4:tabstop=4:expandtab
